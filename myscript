#!/bin/bash

set -e

# update/upgrade system
apt update -y && apt upgrade -y

# install nginx, MySQL, php
apt install -y nginx mysql-server php-fpm php-mysql

# start everything
systemctl start nginx
systemctl start mysql
systemctl start php7.4-fpm

# enable everything (will start after reboot)
systemctl enable nginx
systemctl enable mysql
systemctl enable php7.4-fpm

# Secure MySQL installation
# Note: Adjust these variables as needed
MYSQL_ROOT_PASSWORD="pa55word"
mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH 'mysql_native_password' BY '${MYSQL_ROOT_PASSWORD}';"
mysql -e "DELETE FROM mysql.user WHERE User='';"
mysql -e "DROP DATABASE IF EXISTS test;"
mysql -e "DELETE FROM mysql.db WHERE Db='test' OR Db='test\\_%';"
mysql -e "FLUSH PRIVILEGES;"

# nginx config (php not done before, c+p chat, placeholders for server/domain)
cat <<EOT > /etc/nginx/sites-available/default
server {
    listen 80;
    server_name your_domain_or_ip;

    root /var/www/html;
    index index.php index.html;

    location / {
        try_files \$uri \$uri/ =404;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    }
}
EOT

# edit index page
echo "<h1>Great Success!</h1>" > /var/www/html/index.html

# nginx restart
systemctl restart nginx

# Create a test PHP file (not done before, c+p from chat)
echo "<?php phpinfo(); ?>" > /var/www/html/info.php

echo "LEMP stack installation completed. You legend"

